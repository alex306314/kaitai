<?php


/**
 * hook_block_info()
 */
function ktmodule_block_info()
{
    $blocks['cycle2banner'] = array(
        'info' => t('滚动横幅块'),
        'cache' => DRUPAL_CACHE_PER_ROLE,
    );
    return $blocks;
}

/**
 * 获取banner图片信息
 * @return array
 */
function ktGetBannerData()
{
  //echo "<pre>";
  $query = db_select('{node}','n');
  $query->leftJoin('{field_data_field_image}', 'i', 'i.entity_id=n.nid');
  $query->leftJoin('{field_data_field_url_to}', 'url', 'url.entity_id=n.nid');
  $query->leftJoin('{file_managed}', 'f', 'f.fid=i.field_image_fid');
  $query->fields('i');
  $query->fields('n');
  $query->fields('url');
  $query->fields('f');
  $query->condition('n.type','front_slide_banner', '=');
  $query->range(0,10);
  $data = $query->execute();
       // ->fetchAssoc();
  $images = array();
  foreach($data as $d){
    //var_dump($d);
    $images[] = array(
      'nid' => $d->nid,
      'title' => $d->title,
      'img' => file_create_url($d->uri),
      'url' => isset($d->field_url_to_value)?$d->field_url_to_value:'#',
    );
  };
  //exit;
    //$files = file_load_multiple($ids);
    //var_dump($images);exit;
  return $images;
}

/**
 * hook_block_view()
 */
function ktmodule_block_view($delta = '')
{
  $block = array();
  $images = ktGetBannerData();
  $html = '<div class="slide myslide" data-cycle-fx="fade" data-cycle-timeout="5000"
        data-cycle-slides="> a"
       data-cycle-easing="linear"><div class="cycle-pager"></div>';
  foreach($images as $i){
    $html .= '<a href="'. $i['url'] .'" style="background-image:url('.$i['img'].');"></a>';
  }
  $html .= '</div>';

  switch($delta){
      case 'cycle2banner'://横幅模块
        //drupal_add_js('misc/jquery-1.11.1.min.js','file');
        drupal_add_js('sites/all/libraries/jquery.cycle/jquery.cycle2.min.js','file');
        $block['subject'] = t('滚动横幅');
        $block['content'] = $html;
  }

  return $block;
}

/**
 * hook_theme
 */
function ktmodule_theme()
{
  return array();
}